#!/bin/bash
# Simple bash script to search for CVE and report via email
# Xavier Mertens <xavier@rootshell.be>
# 
# Copyright: GPLv3 (http://gplv3.fsf.org/)
# Feel free to use the code, but please share the changes you've made

# Replace with your own search.py path
SEARCHCMD="/opt/cve-search/bin/search.py"
CONFIG="cve-tracker.conf"

if [ ! -x "$SEARCHCMD" ]; then
        echo "$SEARCHCMD not found. CVE-Search is not installed?"
        exit 1
fi

if [ ! -r "$CONFIG" ]; then
        echo "Cannot read the config file: $CONFIG"
        exit 1
fi

cat $CONFIG | while read LINE
do
        EMAIL=`echo $LINE | awk -F '|' '{ print $1 }'`
        DAYS=`echo $LINE | awk -F '|' '{ print $2 }'`
        FORMAT=`echo $LINE | awk -F '|' '{ print $3 }'`
        echo "Processing: $EMAIL"
        echo $LINE | awk '{ split($0,f,"|"); i=4; while (length(f[i])>0) { print f[i]; i++ } }' | while read PRODUCT
        do
                echo "Product: $PRODUCT"
                TMPFILE=`mktemp /tmp/cve-tracker.XXXXXX`
                $SEARCHCMD -p $PRODUCT -t $DAYS -o $FORMAT > $TMPFILE
                if [ -s $TMPFILE ]; then
                        echo "Found new CVE for $PRODUCT..."
                        TMPMAIL=`mktemp /tmp/ssmtp.XXXXXX`
                        cat <<__MAIL__ >$TMPMAIL
To: $EMAIL
From: cvesearch-bot@rootshell.be
Subject: New CVE found for $PRODUCT

__MAIL__
                        cat $TMPFILE >>$TMPMAIL
                        ssmtp $EMAIL <$TMPMAIL
                        rm $TMPMAIL
                fi
                rm $TMPFILE
        done
done